#!/bin/bash
set -e

echo "=== Weft Finance BOOTSTRAP DESTRUCTION ==="
echo "‚ö†Ô∏è  WARNING: This will DESTROY the SHARED infrastructure:"
echo "   - Terraform State S3 Bucket"
echo "   - DynamoDB Lock Table"
echo ""
read -p "Are you sure? [y/N] " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    exit 1
fi

# Source common utilities
source "$(dirname "${BASH_SOURCE[0]}")/common.sh"
export_aws_credentials
setup_terraform_env

echo "=== Account Validation ==="
echo "AWS Region: ${AWS_REGION}"
echo "Account ID: ${ACCOUNT_ID}"
echo "=========================="

# --- Emergency Manual Cleanup Function ---
manual_cleanup() {
    echo ""
    echo "üö® EMERGENCY MANUAL CLEANUP üö®"
    echo "Terraform is broken, cleaning up via AWS CLI..."
    
    # 1. Delete ECR Repos
    echo "üóëÔ∏è  Deleting ECR Repositories..."
    aws ecr delete-repository --repository-name weft-indexer --force >/dev/null 2>&1 || true
    aws ecr delete-repository --repository-name weft-liquidator --force >/dev/null 2>&1 || true
    
    # 2. Delete S3 State Bucket
    echo "üóëÔ∏è  Deleting State Bucket ${STATE_BUCKET}..."
    aws s3 rb s3://${STATE_BUCKET} --force >/dev/null 2>&1 || true
    
    # 3. Delete DynamoDB Table
    echo "üóëÔ∏è  Deleting DynamoDB Table ${DYNAMODB_TABLE}..."
    aws dynamodb delete-table --table-name ${DYNAMODB_TABLE} >/dev/null 2>&1 || true
    
    # 4. Local Cleanup
    echo "üóëÔ∏è  Cleaning up local files..."
    rm -f backend.tf backend.tf.backup
    rm -rf .terraform .terraform.lock.hcl
    
    echo "‚úÖ Manual cleanup complete."
    exit 0
}

echo ""
echo "--- Initializing Bootstrap State ---"
cd "${PROJECT_ROOT}/terraform/bootstrap"

# Ensure we have state for bootstrap (local or remote)
set +e # Allow init to fail so we can catch it
if [ -f "backend.tf" ]; then
    INIT_ERROR=$(tf_init "bootstrap.tfstate" 2>&1 > /dev/null)
else
    INIT_ERROR=$(terraform init 2>&1 > /dev/null)
fi
STATUS=$?
set -e

if [ $STATUS -ne 0 ]; then
    echo "‚ùå Terraform Initialization Failed."
    echo "${INIT_ERROR}"
    exit 1
fi

if [ -z "$STATE_BUCKET" ]; then
    echo "‚ùå Error: Could not resolve State Bucket. Is bootstrap deployed?"
    exit 1
fi

echo "Checking for active deployments in ${STATE_BUCKET}..."
# List all objects ending in .tfstate, excluding bootstrap.tfstate
ACTIVE_STATES=$(aws s3api list-objects-v2 --bucket ${STATE_BUCKET} --query 'Contents[].Key' --output text 2>/dev/null | tr '\t' '\n' | grep ".tfstate" | grep -v "bootstrap.tfstate" || true)

if [ ! -z "$ACTIVE_STATES" ]; then
    echo "‚ùå ABORTING: Active application states found:"
    echo "${ACTIVE_STATES}"
    echo ""
    if [[ "$*" == *"--force"* ]]; then
        echo "‚ö†Ô∏è  FORCE flag detected. Proceeding despite active states..."
    else
        echo "Please run ./scripts/destroy-app.sh <env> for each of these environments first."
        echo "Or use ./scripts/destroy-bootstrap.sh --force to bypass this check."
        exit 1
    fi
fi

echo "‚úÖ No active apps found. Proceeding with destruction."

# --- State Migration (Fixed Checksum Error) ---
# We must move the state from S3 to local BEFORE we empty the bucket,
# otherwise Terraform will lose its own state file and fail with a checksum error.
echo "--- Migrating State to Local ---"
if [ -f "backend.tf" ]; then
    echo "Migrating state from S3 to local storage..."
    rm -f backend.tf
    # We use -force-copy to automatically answer 'yes' to the migration prompt
    terraform init -migrate-state -force-copy > /dev/null || {
        echo "‚ùå ERROR: State migration failed."
        echo "   You may need to manually clean up resources via AWS Console or CLI."
        exit 1
    }
else
    echo "State is already local or no backend.tf found."
fi

# Empty S3 Bucket (Required for delete)
# Now safe because state is local
echo "Emptying State Bucket ${STATE_BUCKET}..."
aws s3api delete-objects --bucket ${STATE_BUCKET} --delete "$(aws s3api list-object-versions --bucket ${STATE_BUCKET} --query='{Objects: Versions[].{Key:Key,VersionId:VersionId}}' --output json)" > /dev/null 2>&1 || true
aws s3api delete-objects --bucket ${STATE_BUCKET} --delete "$(aws s3api list-object-versions --bucket ${STATE_BUCKET} --query='{Objects: DeleteMarkers[].{Key:Key,VersionId:VersionId}}' --output json)" > /dev/null 2>&1 || true

echo "--- Destroying Bootstrap Infrastructure ---"
terraform destroy -auto-approve || {
    echo "‚ùå ERROR: Terraform destroy failed."
    echo "   You may need to manually clean up resources via AWS Console or CLI."
    exit 1
}

# Cleanup local backend.tf
rm -f backend.tf backend.tf.backup
rm -rf .terraform .terraform.lock.hcl
cd "${SCRIPT_DIR}"

echo "‚úÖ Shared Bootstrap resources destroyed."
