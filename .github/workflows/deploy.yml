name: Deploy Weft Finance

on:
  push:
    branches: [ main ]

permissions:
  id-token: write # Required for OIDC
  contents: read

jobs:
  filter:
    runs-on: ubuntu-latest
    outputs:
      indexer: ${{ steps.filter.outputs.indexer }}
      liquidator: ${{ steps.filter.outputs.liquidator }}
      app: ${{ steps.filter.outputs.app }}
      bootstrap: ${{ steps.filter.outputs.bootstrap }}
      ecr: ${{ steps.filter.outputs.ecr }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            indexer:
              - 'indexer/**'
            liquidator:
              - 'liquidator/**'
            app:
              - 'terraform/app/**'
              - 'dispatcher/**'
            bootstrap:
              - 'terraform/bootstrap/**'
            ecr:
              - 'terraform/ecr/**'



  deploy-bootstrap:
    needs: filter
    if: needs.filter.outputs.bootstrap == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/weft-github-actions-role
          aws-region: us-east-1
      - name: Get AWS Account ID
        id: account
        run: echo "id=$(aws sts get-caller-identity --query Account --output text)" >> $GITHUB_OUTPUT
      
      - name: Terraform Init
        working-directory: terraform/bootstrap
        run: |
          terraform init -reconfigure \
            -backend-config="bucket=weft-terraform-state-${{ steps.account.outputs.id }}" \
            -backend-config="dynamodb_table=weft-terraform-locks" \
            -backend-config="key=bootstrap.tfstate" \
            -backend-config="region=us-east-1"
      
      - name: Terraform Apply
        working-directory: terraform/bootstrap
        run: terraform apply -auto-approve

  deploy-ecr:
    needs: filter
    if: needs.filter.outputs.ecr == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/weft-github-actions-role
          aws-region: us-east-1
      - name: Get AWS Account ID
        id: account
        run: echo "id=$(aws sts get-caller-identity --query Account --output text)" >> $GITHUB_OUTPUT
      
      - name: Terraform Init
        working-directory: terraform/ecr
        run: |
          terraform init -reconfigure \
            -backend-config="bucket=weft-terraform-state-${{ steps.account.outputs.id }}" \
            -backend-config="dynamodb_table=weft-terraform-locks" \
            -backend-config="key=ecr.tfstate" \
            -backend-config="region=us-east-1"
      
      - name: Terraform Apply
        working-directory: terraform/ecr
        run: terraform apply -auto-approve



  build-indexer:
    needs: filter
    if: needs.filter.outputs.indexer == 'true'
    runs-on: ubuntu-latest
    outputs:
      digest: ${{ steps.build.outputs.indexer_digest }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install PNPM
        run: corepack enable && corepack prepare pnpm@latest --activate
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/weft-github-actions-role
          aws-region: us-east-1
      - name: Build & Push Indexer
        id: build
        run: ./scripts/build-push.sh indexer ${{ github.sha }}

  build-liquidator:
    needs: filter
    if: needs.filter.outputs.liquidator == 'true'
    runs-on: ubuntu-latest
    outputs:
      digest: ${{ steps.build.outputs.liquidator_digest }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install PNPM
        run: corepack enable && corepack prepare pnpm@latest --activate
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/weft-github-actions-role
          aws-region: us-east-1
      - name: Build & Push Liquidator
        id: build
        run: ./scripts/build-push.sh liquidator ${{ github.sha }}

  # --- Main Deployment Job ---

  deploy-app:
    needs: [filter, build-indexer, build-liquidator]
    # Run if app infra changed OR if any image was rebuilt
    if: always() && (needs.filter.outputs.app == 'true' || needs.build-indexer.result == 'success' || needs.build-liquidator.result == 'success')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install PNPM
        run: corepack enable && corepack prepare pnpm@latest --activate
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/weft-github-actions-role
          aws-region: us-east-1
      
      - name: Bundle Dispatcher Lambda
        working-directory: dispatcher
        run: |
          pnpm install
          pnpm run bundle
      
      - name: Resolve Image Digests
        id: digests
        run: |
          # Fetch digests if jobs were skipped
          INDEXER="${{ needs.build-indexer.outputs.digest }}"
          if [ -z "$INDEXER" ]; then
            INDEXER=$(./scripts/build-push.sh get-digest indexer latest)
          fi
          
          LIQUIDATOR="${{ needs.build-liquidator.outputs.digest }}"
          if [ -z "$LIQUIDATOR" ]; then
            LIQUIDATOR=$(./scripts/build-push.sh get-digest liquidator latest)
          fi
          
          echo "indexer=$INDEXER" >> $GITHUB_OUTPUT
          echo "liquidator=$LIQUIDATOR" >> $GITHUB_OUTPUT

      - name: Get AWS Account ID
        id: account
        run: echo "id=$(aws sts get-caller-identity --query Account --output text)" >> $GITHUB_OUTPUT
      
      - name: Terraform Init
        working-directory: terraform/app
        run: |
          terraform init -reconfigure \
            -backend-config="bucket=weft-terraform-state-${{ steps.account.outputs.id }}" \
            -backend-config="dynamodb_table=weft-terraform-locks" \
            -backend-config="key=weft-mainnet.tfstate" \
            -backend-config="region=us-east-1"
      
      - name: Select/Create Workspace
        working-directory: terraform/app
        run: terraform workspace select mainnet || terraform workspace new mainnet
      
      - name: Terraform Apply
        working-directory: terraform/app
        env:
          TF_VAR_indexer_image_digest: ${{ steps.digests.outputs.indexer }}
          TF_VAR_liquidator_image_digest: ${{ steps.digests.outputs.liquidator }}
          TF_VAR_liquidation_seed_phrase: ${{ secrets.LIQUIDATION_SEED_PHRASE }}
        run: terraform apply -var-file="mainnet.tfvars" -auto-approve

