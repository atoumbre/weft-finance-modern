name: Deploy Weft Finance

on:
  push:
    branches: [ main ]

permissions:
  id-token: write # Required for OIDC
  contents: read

jobs:
  filter:
    runs-on: ubuntu-latest
    outputs:
      indexer: ${{ steps.filter.outputs.indexer }}
      liquidator: ${{ steps.filter.outputs.liquidator }}
      backend: ${{ steps.filter.outputs.backend }}
      bootstrap: ${{ steps.filter.outputs.bootstrap }}
      ecr: ${{ steps.filter.outputs.ecr }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            bootstrap:
              - 'terraform/bootstrap/**'
            ecr:
              - 'terraform/ecr/**'
            indexer:
              - 'indexer/**'
            liquidator:
              - 'liquidator/**'
            backend:
              - 'terraform/backend/**'
              - 'dispatcher/**'

  typo-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install cspell
        run: npm install -g cspell
      - name: Typos
        run: cspell -c ./cspell.json . --quiet




  deploy-bootstrap:
    needs: [filter, typo-check]
    if: needs.filter.outputs.bootstrap == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/weft-github-actions-role
          aws-region: us-east-1
      - name: Get AWS Account ID
        id: account
        run: echo "id=$(aws sts get-caller-identity --query Account --output text)" >> $GITHUB_OUTPUT
      
      - name: Terraform Init
        working-directory: terraform/bootstrap
        run: |
          terraform init -reconfigure \
            -backend-config="bucket=weft-terraform-state-${{ steps.account.outputs.id }}" \
            -backend-config="dynamodb_table=weft-terraform-locks" \
            -backend-config="key=bootstrap.tfstate" \
            -backend-config="region=us-east-1"
      
      - name: Terraform Apply
        working-directory: terraform/bootstrap
        run: terraform apply -auto-approve

  deploy-ecr:
    needs: [filter, typo-check]
    if: needs.filter.outputs.ecr == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/weft-github-actions-role
          aws-region: us-east-1
      - name: Get AWS Account ID
        id: account
        run: echo "id=$(aws sts get-caller-identity --query Account --output text)" >> $GITHUB_OUTPUT
      
      - name: Terraform Init
        working-directory: terraform/ecr
        run: |
          terraform init -reconfigure \
            -backend-config="bucket=weft-terraform-state-${{ steps.account.outputs.id }}" \
            -backend-config="dynamodb_table=weft-terraform-locks" \
            -backend-config="key=ecr.tfstate" \
            -backend-config="region=us-east-1"
      
      - name: Terraform Apply
        working-directory: terraform/ecr
        run: terraform apply -auto-approve



  build-indexer:
    needs: [filter, typo-check]
    if: needs.filter.outputs.indexer == 'true'
    runs-on: ubuntu-latest
    outputs:
      digest: ${{ steps.build.outputs.indexer_digest }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.2.13"
      - name: Install PNPM
        run: corepack enable && corepack prepare pnpm@latest --activate
      - name: Test Indexer
        run: |
          pnpm -C indexer install --frozen-lockfile
          pnpm -C indexer test
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/weft-github-actions-role
          aws-region: us-east-1
      - name: Build & Push Indexer
        id: build
        run: ./scripts/build-push.sh indexer

  build-liquidator:
    needs: [filter, typo-check]
    if: needs.filter.outputs.liquidator == 'true'
    runs-on: ubuntu-latest
    outputs:
      digest: ${{ steps.build.outputs.liquidator_digest }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install PNPM
        run: corepack enable && corepack prepare pnpm@latest --activate
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/weft-github-actions-role
          aws-region: us-east-1
      - name: Build & Push Liquidator
        id: build
        run: ./scripts/build-push.sh liquidator

  deploy-backend:
    needs: [filter, typo-check]
    if: needs.filter.outputs.backend == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.2.13"
      - name: Install PNPM
        run: corepack enable && corepack prepare pnpm@latest --activate
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/weft-github-actions-role
          aws-region: us-east-1
      
      - name: Test Dispatcher Lambda
        run: |
          pnpm -C dispatcher install --frozen-lockfile
          pnpm -C dispatcher test
      - name: Bundle Dispatcher Lambda
        run: pnpm -C dispatcher bundle
      
      - name: Get AWS Account ID
        id: account
        run: echo "id=$(aws sts get-caller-identity --query Account --output text)" >> $GITHUB_OUTPUT
      
      - name: Terraform Init
        working-directory: terraform/backend
        run: |
          terraform init -reconfigure \
            -backend-config="bucket=weft-terraform-state-${{ steps.account.outputs.id }}" \
            -backend-config="dynamodb_table=weft-terraform-locks" \
            -backend-config="key=weft-mainnet.tfstate" \
            -backend-config="region=us-east-1"
      
      - name: Select/Create Workspace
        working-directory: terraform/backend
        run: terraform workspace select mainnet || terraform workspace new mainnet
      
      - name: Terraform Apply
        working-directory: terraform/backend
        env:
          TF_VAR_liquidation_seed_phrase: ${{ secrets.LIQUIDATION_SEED_PHRASE }}
        run: terraform apply -var-file="mainnet.tfvars" -auto-approve
