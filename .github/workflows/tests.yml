name: Tests

on:
  push:
    branches: [main, stage, dev]
  pull_request:
    branches: [main, stage]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read

jobs:
  typo-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install cspell
        run: npm install -g cspell
      - name: Typos
        run: cspell -c ./cspell.json . --quiet

  filter:
    runs-on: ubuntu-latest
    needs: [typo-check]
    outputs:
      dispatcher: ${{ steps.filter.outputs.dispatcher }}
      indexer: ${{ steps.filter.outputs.indexer }}
      liquidator: ${{ steps.filter.outputs.liquidator }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            dispatcher:
              - "services/functions/dispatcher/**"
            indexer:
              - "services/containers/indexer/**"
            liquidator:
              - "services/containers/liquidator/**"

  test-dispatcher:
    runs-on: ubuntu-latest
    needs: [filter]
    if: needs.filter.outputs.dispatcher == 'true'
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.2.13"
      - name: Enable Corepack
        run: corepack enable && corepack prepare pnpm@latest --activate
      - name: Install Dependencies
        run: pnpm install --frozen-lockfile
        working-directory: services/functions/dispatcher
      - name: Test
        run: pnpm test
        working-directory: services/functions/dispatcher

  test-indexer:
    runs-on: ubuntu-latest
    needs: [filter]
    if: needs.filter.outputs.indexer == 'true'
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.2.13"
      - name: Enable Corepack
        run: corepack enable && corepack prepare pnpm@latest --activate
      - name: Install Dependencies
        run: pnpm install --frozen-lockfile
        working-directory: services/containers/indexer
      - name: Test
        run: pnpm test
        working-directory: services/containers/indexer
